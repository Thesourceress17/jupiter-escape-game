<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בריחה מכוכב צדק - משחק חינוכי</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(to bottom, #4c1d95, #000000);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .intro-screen {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            background: #1f2937;
            padding: 40px;
            border-radius: 16px;
            border: 2px solid #facc15;
        }
        
        .game-screen {
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fde047;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #d1d5db;
        }
        
        .rules-section {
            text-align: right;
            background: #374151;
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .start-button {
            background: #16a34a;
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .start-button:hover {
            background: #15803d;
        }
        
        .dice-container {
            text-align: center;
            background: #1f2937;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #4b5563;
        }
        
        .dice {
            display: inline-block;
            width: 60px;
            height: 60px;
            background: white;
            color: #1f2937;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .dice.rolling {
            animation: rollDice 0.5s ease-in-out;
        }
        
        @keyframes rollDice {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1.2); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .board-container {
            background: #1f2937;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .board-title {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .board {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .board-row {
            display: flex;
            gap: 8px;
        }
        
        .board-square {
            width: 55px;
            height: 55px;
            border: 2px solid #4b5563;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            position: relative;
        }
        
        .square-start { background-color: #16a34a; }
        .square-end { background-color: #eab308; }
        .square-dilemma { background-color: #dc2626; }
        .square-normal { background-color: #374151; }
        
        .player-piece {
            position: absolute;
            bottom: 2px;
            width: 9px;
            height: 9px;
            border-radius: 50%;
            border: 1px solid white;
        }
        
        .player-1 { background-color: #3b82f6; left: 4px; }
        .player-2 { background-color: white; left: 14px; border-color: #4b5563; }
        .player-3 { background-color: #22c55e; left: 24px; }
        .player-4 { background-color: #a855f7; left: 34px; }
        
        .warning-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 9px;
        }
        
        .game-log {
            background: #1f2937;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #facc15;
        }
        
        .log-entry {
            background: #374151;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .player-card {
            background: #1f2937;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #4b5563;
        }
        
        .player-active {
            border-color: #facc15;
            background: rgba(250, 204, 21, 0.1);
        }
        
        .player-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-bottom: 8px;
        }
        
        .scoreboard {
            background: linear-gradient(to right, #92400e, #c2410c);
            border: 2px solid #facc15;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .scoreboard-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #fde047;
            margin-bottom: 15px;
        }
        
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .score-card {
            background: rgba(55, 65, 81, 0.5);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .score-leader {
            background: rgba(250, 204, 21, 0.3);
            border: 2px solid #fde047;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .current-player {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .game-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 8px;
        }
        
        .game-button:hover {
            background: #1d4ed8;
        }
        
        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .bonus-button {
            background: #16a34a;
        }
        
        .bonus-button:hover {
            background: #15803d;
        }
        
        .dilemma-modal {
            background: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .dilemma-content {
            background: #1f2937;
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .dilemma-title {
            color: #fca5a5;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        .card-button {
            background: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: right;
            cursor: pointer;
        }
        
        .card-selected {
            background: #2563eb;
            border-color: #60a5fa;
        }
        
        .hint-box {
            background: rgba(234, 88, 12, 0.3);
            border: 1px solid #ea580c;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        
        .feedback-box {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .feedback-correct {
            background: rgba(34, 197, 94, 0.3);
            border: 1px solid #22c55e;
        }
        
        .feedback-partial {
            background: rgba(250, 204, 21, 0.3);
            border: 1px solid #facc15;
        }
        
        .feedback-wrong {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid #ef4444;
        }
        
        .correct-answer {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        textarea {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            background: #374151;
            border: 1px solid #4b5563;
            color: white;
            resize: vertical;
            min-height: 80px;
        }
        
        .legend {
            text-align: center;
            margin-top: 16px;
            font-size: 0.9rem;
            color: #d1d5db;
        }
        
        @media (max-width: 768px) {
            .board-square {
                width: 40px;
                height: 40px;
                font-size: 9px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- מסך הוראות -->
    <div id="introScreen" class="intro-screen">
        <h1 class="title">🚀 בריחה מכוכב צדק</h1>
        <p class="subtitle">משחק אסטרטגיה הנדסי לתלמידים ותלמידות כיתה ח'</p>
        <p style="font-size: 0.9rem; color: #9ca3af; margin-top: 8px;">יוצר על ידי Thesourceress17 💫</p>
        
        <div class="rules-section">
            <h3 style="margin-bottom: 16px; color: #fde047;">📋 הוראות המשחק</h3>
            <div style="font-size: 0.9rem; line-height: 1.6;">
                <p style="margin-bottom: 12px;"><strong>🎯 מטרה:</strong> להיות הראשון להגיע למשבצת 34 ולברוח בהצלחה מכוכב צדק!</p>
                
                <p style="margin-bottom: 12px;"><strong>🎲 איך משחקים:</strong></p>
                <p style="margin-bottom: 8px;">1️⃣ השחקן הפעיל לוחץ על "הטל קובייה וזוז"</p>
                <p style="margin-bottom: 8px;">2️⃣ הקובייה מתגלגלת והשחקן זז אוטומטית</p>
                <p style="margin-bottom: 8px;">3️⃣ משבצות אפורות = רק מתקדמים</p>
                <p style="margin-bottom: 12px;">4️⃣ משבצות אדומות עם ⚠️ = פותרים דילמה הנדסית!</p>
                
                <p style="margin-bottom: 12px;"><strong>🔬 פתרון דילמות:</strong></p>
                <p style="margin-bottom: 8px;">• קוראים את הבעיה ההנדסית בקפידה</p>
                <p style="margin-bottom: 8px;">• בוחרים קלף שמתאים לפתרון מהרשימה</p>
                <p style="margin-bottom: 8px;">• כותבים הסבר של לפחות 30 תווים איך הקלף פותר את הבעיה</p>
                <p style="margin-bottom: 8px;">• אם תקועים - לוחצים על כפתור הרמז (מורידים נקודה)</p>
                <p style="margin-bottom: 12px;">• לוחצים "פתור את הדילמה"</p>
                
                <p style="margin-bottom: 12px;"><strong>🏆 ניקוד והתקדמות:</strong></p>
                <p style="margin-bottom: 8px;">✅ <strong>תשובה מצוינת</strong> = 3 צעדי בונוס + תור נוסף + נקודות גבוהות</p>
                <p style="margin-bottom: 8px;">⚡ <strong>תשובה טובה</strong> = 1 צעד בונוס + תור נוסף + נקודות</p>
                <p style="margin-bottom: 12px;">❌ <strong>תשובה שגויה</strong> = אין בונוס, עוברים לשחקן הבא</p>
                
                <p style="margin-bottom: 12px;"><strong>💡 עצות לניצחון:</strong></p>
                <p style="margin-bottom: 8px;">• חשבו מדעית! הדילמות דורשות פתרונות הנדסיים אמיתיים</p>
                <p style="margin-bottom: 8px;">• קראו בקפידה את התיאור של כל קלף</p>
                <p style="margin-bottom: 8px;">• כתבו הסברים מפורטים עם מונחים מדעיים</p>
                <p style="margin-bottom: 8px;">• השתמשו במידע על כוכב צדק שלמדתם בכיתה</p>
                <p>• הקובייה "חכמה" - תכוון אתכם לדילמות כדי ללמוד יותר!</p>
            </div>
        </div>
        
        <button class="start-button" onclick="startGame()">
            🚀 התחל משחק - ברחו מכוכב צדק!
        </button>
    </div>

    <!-- מסך המשחק -->
    <div id="gameScreen" class="game-screen">
        <div class="container">
            <!-- כותרת -->
            <div class="header">
                <h1 class="title">🚀 בריחה מכוכב צדק</h1>
                <p class="subtitle">משחק אסטרטגיה הנדסי - בעיצומו!</p>
            </div>

            <!-- קובייה -->
            <div class="dice-container" id="diceContainer">
                <div class="current-player">
                    תור של: <span style="color: #fde047; font-weight: bold;" id="currentPlayerName">מהנדס 1</span>
                </div>
                <div id="bonusMessage" style="display: none; color: #86efac; font-weight: bold; margin-bottom: 10px;">
                    🎉 תור בונוס! הצלחת לפתור את הדילמה!
                </div>
                <div class="dice" id="diceDisplay">1</div>
                <br>
                <button onclick="handlePlayerTurn()" class="game-button" id="rollButton">
                    🎲 הטל קובייה וזוז
                </button>
            </div>

            <!-- יומן המשחק -->
            <div class="game-log">
                <h3 style="margin-bottom: 12px;">📖 יומן המשחק</h3>
                <div id="gameLog">
                    <div class="log-entry">המשחק התחיל! בהצלחה!</div>
                </div>
            </div>

            <!-- לוח המשחק -->
            <div class="board-container">
                <h3 class="board-title">🛤️ מסלול הבריחה מכוכב צדק (35 משבצות)</h3>
                <div class="board" id="gameBoard">
                    <!-- הלוח ייבנה ב-JavaScript -->
                </div>
                <div class="legend">
                    🏁 התחלה | ⚠️ דילמה הנדסית | 🎯 שיגור מוצלח!
                </div>
            </div>

            <!-- מידע שחקנים -->
            <div class="players-grid" id="playersInfo">
                <!-- מידע השחקנים ייבנה ב-JavaScript -->
            </div>

            <!-- לוח ניקוד קטן -->
            <div class="scoreboard">
                <h3 class="scoreboard-title">🏆 ניקוד</h3>
                <div class="score-grid" id="scoreBoard">
                    <!-- לוח הניקוד ייבנה ב-JavaScript -->
                </div>
            </div>

            <!-- כפתור איפוס -->
            <div style="text-align: center; border-top: 1px solid #4b5563; padding-top: 20px;">
                <button onclick="resetGame()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    🔄 משחק חדש
                </button>
                <button onclick="showRules()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-right: 10px;">
                    📋 הצג הוראות
                </button>
            </div>
        </div>
    </div>

    <!-- מודל דילמה -->
    <div id="dilemmaModal" class="dilemma-modal" style="display: none;">
        <div class="dilemma-content">
            <h3 class="dilemma-title">🚨 דילמה הנדסית!</h3>
            <div id="dilemmaContent">
                <!-- תוכן הדילמה ייבנה ב-JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // נתוני המשחק
        let players = [
            { id: 1, name: 'מהנדס 1', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-1', turnsSinceDilemma: 0 },
            { id: 2, name: 'מהנדסת 2', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-2', turnsSinceDilemma: 0 },
            { id: 3, name: 'מהנדס 3', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-3', turnsSinceDilemma: 0 },
            { id: 4, name: 'מהנדסת 4', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-4', turnsSinceDilemma: 0 }
        ];

        let currentPlayer = 0;
        let diceValue = 1;
        let gameLog = [];
        let bonusTurn = false;
        let selectedCard = null;
        let currentDilemma = null;
        let showHint = false;
        let answerFeedback = null;
        let explanation = '';
        let usedDilemmas = []; // למעקב אחרי דילמות שכבר שאלנו

        const boardPositions = 35;
        const dilemmaSquares = [3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 16, 25]; // 13 דילמות

        // קלפי ידע
        const knowledgeCards = [
            { id: 1, type: 'physics', name: 'חוקי ניוטון', description: 'כוח, תאוצה ותנועה', icon: '🔬', hint: 'חוק שלישי: לכל פעולה יש תגובה. ברקטות הגזים דוחפים החללית קדימה!' },
            { id: 2, type: 'physics', name: 'כוח כבידה', description: 'מהירות בריחה ומסלולים', icon: '🌍', hint: 'כדי לברוח מכוכב לכת צריך להגיע למהירות בריחה - בצדק זה 60 קמ/ש!' },
            { id: 3, type: 'physics', name: 'דינמיקת נוזלים', description: 'זרימת גזים ולחץ אטמוספרי', icon: '🌪️', hint: 'הגזים זורמים ממקום עם לחץ גבוה למקום עם לחץ נמוך' },
            { id: 4, type: 'engineering', name: 'מנועי רקטה', description: 'דחף ויעילות מנוע', icon: '🚀', hint: 'המנוע דוחף גזים החוצה ביעילות מקסימלית כדי לחסוך דלק' },
            { id: 5, type: 'engineering', name: 'מגנים תרמיים', description: 'הגנה מפני חום וקרינה', icon: '🛡️', hint: 'לוחות מיוחדים שמחזירים חום ומגנים על המבנה של החללית' },
            { id: 6, type: 'engineering', name: 'מערכות ניווט', description: 'GPS חללי וחישוב מסלולים', icon: '🧭', hint: 'מחשבים מחשבים מסלולים בזמן אמת תוך התחשבות בכבידה של כוכבי לכת' },
            { id: 7, type: 'engineering', name: 'אנטנות תקשורת', description: 'שידור אותות למרחק גדול', icon: '📡', hint: 'אנטנה מכוונת וחזקה יותר יכולה לשדר אותות למרחקים רחוקים יותר' },
            { id: 8, type: 'teamwork', name: 'פרוטוקולי חירום', description: 'תיאום צוות במצבי לחץ', icon: '🚨', hint: 'כשיש בעיה טכנית, חשוב שכל הצוות יעבוד לפי תוכנית מתואמת' },
            { id: 9, type: 'engineering', name: 'מערכות קירור', description: 'שליטה בטמפרטורה', icon: '❄️', hint: 'מערכת קירור פעילה מורידה חום באמצעות נוזל קירור או גזים' },
            { id: 10, type: 'physics', name: 'אווירודינמיקה', description: 'התנגדות אוויר וזרימה', icon: '✈️', hint: 'צורה חלקה וייעול הזרימה מפחיתים התנגדות ומאפשרים תנועה מהירה יותר' }
        ];

        // דילמות עם תשובות נכונות - כל דילמה קשורה למשבצת ספציפית
        const dilemmaCards = [
            { 
                id: 1, position: 3,
                title: 'חום קיצוני פוגע בחללית!', 
                description: 'החללית מתחממת ל-800 מעלות צלזיוס כשחודרת לאטמוספירה של צדק. הרכיבים מתחילים להימס!', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 2,
                keywords: ['חום', 'הגנה', 'מגן', 'תרמי', 'קירור', 'טמפרטורה'],
                correctAnswer: 'הפתרון הנכון: להתקין מגנים תרמיים - לוחות מיוחדים המחזירים חום ומגנים על מבנה החללית. בנוסף, מערכות קירור פעילות יכולות להוריד את הטמפרטורה באמצעות נוזל קירור.'
            },
            { 
                id: 2, position: 6,
                title: 'רוחות של 500 קמ/ש מסיטות אותנו!', 
                description: 'סופות ענק בצדק יוצרות רוחות חזקות שדוחפות את החללית למסלול מסוכן לעבר הירחים שלו.', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 2,
                keywords: ['רוח', 'ניווט', 'כיוון', 'מסלול', 'שליטה', 'דינמיקה'],
                correctAnswer: 'הפתרון הנכון: שימוש במערכות ניווט מתקדמות לחישוב מסלול חדש בזמן אמת, יחד עם עקרונות אווירודינמיקה ליצירת צורה חלקה שמפחיתה התנגדות לרוח.'
            },
            { 
                id: 3, position: 9,
                title: 'כוח הכבידה חזק מדי למנועים!', 
                description: 'כוח הכבידה של צדק פי 2.5 מכדור הארץ. המנועים שלנו לא מספיק חזקים להגיע למהירות בריחה!', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 3,
                keywords: ['כבידה', 'מנוע', 'דחף', 'מהירות', 'כוח', 'ניוטון'],
                correctAnswer: 'הפתרון הנכון: שימוש במנועי רקטה בעלי דחף גבוה יותר, תוך הפעלת חוק ניוטון השלישי - הגזים נדחפים החוצה במהירות גבוהה, ולכן החללית נדחפת בכיוון ההפוך בכוח רב.'
            },
            { 
                id: 4, position: 12,
                title: 'קרינה מגנטית פוגעת במחשבים!', 
                description: 'השדה המגנטי הענק של צדק גורם למערכות האלקטרוניקה להשתגע ולמחשבים לקרוס.', 
                requiredTypes: ['engineering', 'teamwork'], 
                difficulty: 2,
                keywords: ['מגנטי', 'הגנה', 'אלקטרוניקה', 'מגן', 'קרינה'],
                correctAnswer: 'הפתרון הנכון: התקנת מגנים מגנטיים מיוחדים סביב המחשבים, יחד עם פרוטוקולי חירום לגיבוי המערכות החיוניות ותיאום הצוות בזמן התקלה.'
            },
            { 
                id: 5, position: 15,
                title: 'איך לחשב מסלול בין 79 ירחים?', 
                description: 'צדק מוקף ב-79 ירחים שמשפיעים על המסלול שלנו. איך נחשב נתיב בטוח שלא יתנגש בהם?', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 2,
                keywords: ['מסלול', 'ניווט', 'חישוב', 'כבידה', 'GPS'],
                correctAnswer: 'הפתרון הנכון: שימוש במערכות ניווט מתקדמות המחשבות את השפעת כוח הכבידה של כל הירחים בזמן אמת, יחד עם הבנת חוקי הכבידה לתכנון מסלול אופטימלי.'
            },
            { 
                id: 6, position: 18,
                title: 'תיקונים דחופים מחוץ לחללית!', 
                description: 'יש תיקונים שצריך לבצע על גוף החללית. האסטרונאוט צריך לצאת החוצה - האם החליפה תגן בקרינה ובטמפרטורות קיצוניות של צדק?', 
                requiredTypes: ['engineering', 'teamwork'], 
                difficulty: 2,
                keywords: ['חליפה', 'הגנה', 'קרינה', 'טמפרטורה', 'בטיחות'],
                correctAnswer: 'הפתרון הנכון: שימוש בחליפות אסטרונאוט מיוחדות עם הגנה תרמית וקרינתית מתקדמת, יחד עם פרוטוקולי חירום קפדניים ותיאום צוות הבטיחות.'
            },
            { 
                id: 7, position: 21,
                title: 'רעידות חזקות פוגעות ביציבות!', 
                description: 'הרעידות והזעזועים מהאטמוספירה הסוערת גורמים לחללית לרעוד בצורה מסוכנת. איך נשמור על יציבות?', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 2,
                keywords: ['רעידה', 'יציבות', 'שליטה', 'אווירודינמיקה', 'זרימה'],
                correctAnswer: 'הפתרון הנכון: שימוש בעקרונות אווירודינמיקה ליצירת עיצוב יציב יותר, יחד עם מערכות בקרה אוטומטיות המתבססות על חוקי התנועה של ניוטון.'
            },
            { 
                id: 8, position: 24,
                title: 'גזים רעילים חודרים לחללית!', 
                description: 'גזי המתאן והאמוניה של צדק רעילים ומסוכנים. הם חודרים דרך נקבים קטנים במערכת אוורור!', 
                requiredTypes: ['engineering'], 
                difficulty: 1,
                keywords: ['גזים', 'הגנה', 'אטימה', 'סינון', 'בטיחות'],
                correctAnswer: 'הפתרון הנכון: התקנת מערכות סינון מתקדמות ומגנים כימיים המונעים חדירת גזים רעילים, יחד עם אטימה מושלמת של כל הסדקים.'
            },
            { 
                id: 9, position: 27,
                title: 'איך למדוד מהירות בריחה?', 
                description: 'אנחנו צריכים להגיע למהירות של 60 קמ/ש כדי לברוח מכוח הכבידה של צדק. איך נדע בדיוק שהגענו למהירות הנכונה?', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 2,
                keywords: ['מהירות', 'מדידה', 'ניווט', 'חישוב', 'כבידה'],
                correctAnswer: 'הפתרון הנכון: שימוש במערכות ניווט מדויקות המודדות מהירות בזמן אמת, תוך הבנת עקרונות כוח הכבידה וחישוב המהירות הנדרשת לבריחה מכוכב הלכת.'
            },
            { 
                id: 10, position: 30,
                title: 'איבדנו קשר רדיו עם כדור הארץ!', 
                description: 'המרחק הענק מכדור הארץ (550 מיליון ק"מ) גורם לאובדן קשר רדיו. איך נשדר אותות בהספק מספיק?', 
                requiredTypes: ['engineering', 'teamwork'], 
                difficulty: 2,
                keywords: ['אנטנה', 'תקשורת', 'רדיו', 'הספק', 'שידור'],
                correctAnswer: 'הפתרון הנכון: שימוש באנטנות תקשורת מתקדמות בהספק גבוה וכיוון מדויק לכדור הארץ, יחד עם פרוטוקולי תקשורת חירום ותיאום צוות.'
            },
            { 
                id: 11, position: 33,
                title: 'דלק מתקפא בטמפרטורות קיצוניות!', 
                description: 'הטמפרטורה בחלל הרחוק מהשמש יורדת ל-180 מעלות מתחת לאפס. הדלק מתקפא וחוסם את הצינורות!', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 2,
                keywords: ['קור', 'דלק', 'חימום', 'זרימה', 'טמפרטורה'],
                correctAnswer: 'הפתרון הנכון: התקנת מערכות חימום לצינורות הדלק ושימוש בעקרונות דינמיקת נוזלים כדי לשמור על זרימה תקינה גם בטמפרטורות קיצוניות.'
            },
            { 
                id: 12, position: 16,
                title: 'לחץ אטמוספרי הורס את המבנה!', 
                description: 'הלחץ האטמוספרי של צדק פי 100 מכדור הארץ! המבנה של החללית מתחיל להתעוות ולהיסדק.', 
                requiredTypes: ['physics', 'engineering'], 
                difficulty: 3,
                keywords: ['לחץ', 'מבנה', 'חוזק', 'עמידות', 'דינמיקה'],
                correctAnswer: 'הפתרון הנכון: שימוש בעקרונות דינמיקת נוזלים להבנת השפעת הלחץ, יחד עם חיזוק המבנה באמצעות חומרים עמידים ועיצוב הנדסי מתקדם.'
            },
            { 
                id: 13, position: 25,
                title: 'מערכות חיוניות נכשלות בו-זמנית!', 
                description: 'מערכת הניווט, הקירור והתקשורת נכשלות באותו הזמן! איך נתעדף את התיקונים בזמן קצר?', 
                requiredTypes: ['teamwork', 'engineering'], 
                difficulty: 3,
                keywords: ['חירום', 'עדיפות', 'תיאום', 'פרוטוקול', 'תיקון'],
                correctAnswer: 'הפתרון הנכון: הפעלת פרוטוקולי חירום מתואמים - קודם תיקון הניווט (בטיחות), אחר כך קירור (ציוד), ולבסוף תקשורת. תיאום צוות חיוני להצלחה.'
            }
        ];

        // פונקציה להתחלת המשחק
        function startGame() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            updateUI();
        }

        // פונקציה להצגת הוראות
        function showRules() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('introScreen').style.display = 'block';
        }

        // מכניקת קובייה חכמה
        function smartDiceRoll() {
            const player = players[currentPlayer];
            let roll = Math.floor(Math.random() * 6) + 1;
            
            if (player.turnsSinceDilemma >= 3) {
                const currentPos = player.position;
                const nextDilemmas = dilemmaSquares.filter(d => d > currentPos).sort((a, b) => a - b);
                
                if (nextDilemmas.length > 0) {
                    const nextDilemma = nextDilemmas[0];
                    const distanceToNext = nextDilemma - currentPos;
                    
                    if (distanceToNext <= 6) {
                        const favoredRoll = distanceToNext;
                        if (Math.random() < 0.6) {
                            roll = favoredRoll;
                        }
                    }
                }
            }
            
            return roll;
        }

        // אנימציית קובייה
        function animateDice(finalValue) {
            const dice = document.getElementById('diceDisplay');
            dice.classList.add('rolling');
            
            let animationStep = 0;
            const animationSteps = 8;
            
            const interval = setInterval(() => {
                dice.textContent = Math.floor(Math.random() * 6) + 1;
                animationStep++;
                
                if (animationStep >= animationSteps) {
                    clearInterval(interval);
                    dice.textContent = finalValue;
                    dice.classList.remove('rolling');
                }
            }, 60);
        }

        // בניית הלוח
        function buildBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';

            const rows = 7;
            const cols = 5;

            for (let row = 0; row < rows; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'board-row';

                for (let col = 0; col < cols; col++) {
                    const position = row * cols + (row % 2 === 0 ? col : cols - 1 - col);
                    if (position >= boardPositions) continue;

                    const square = document.createElement('div');
                    square.className = 'board-square';

                    if (position === 0) {
                        square.classList.add('square-start');
                    } else if (position === boardPositions - 1) {
                        square.classList.add('square-end');
                    } else if (dilemmaSquares.includes(position)) {
                        square.classList.add('square-dilemma');
                    } else {
                        square.classList.add('square-normal');
                    }

                    square.innerHTML = `<span>${position}</span>`;

                    if (dilemmaSquares.includes(position)) {
                        square.innerHTML += '<span class="warning-icon">⚠️</span>';
                    } else if (position === 0) {
                        square.innerHTML += '<span class="warning-icon">🏁</span>';
                    } else if (position === boardPositions - 1) {
                        square.innerHTML += '<span class="warning-icon">🎯</span>';
                    }

                    players.forEach(player => {
                        if (player.position === position) {
                            const piece = document.createElement('div');
                            piece.className = `player-piece ${player.color}`;
                            square.appendChild(piece);
                        }
                    });

                    rowDiv.appendChild(square);
                }
                board.appendChild(rowDiv);
            }
        }

        // עדכון מידע שחקנים
        function updatePlayersInfo() {
            const playersInfo = document.getElementById('playersInfo');
            playersInfo.innerHTML = '';

            players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = `player-card ${index === currentPlayer ? 'player-active' : ''}`;
                
                const colorMap = {
                    'player-1': '#3b82f6',
                    'player-2': '#ffffff',
                    'player-3': '#22c55e',
                    'player-4': '#a855f7'
                };

                card.innerHTML = `
                    <div class="player-color" style="background-color: ${colorMap[player.color]}; ${player.color === 'player-2' ? 'border: 2px solid #4b5563;' : ''}"></div>
                    <h3 style="font-weight: bold; margin-bottom: 8px;">${player.name}</h3>
                    <div style="font-size: 0.9rem;">
                        <div style="margin-bottom: 4px;">📍 מיקום: ${player.position}</div>
                        <div style="margin-bottom: 4px;">⚡ אנרגיה: ${player.energy}</div>
                        <div style="margin-bottom: 4px;">🧠 ידע: ${player.knowledge}</div>
                        <div>🏆 ניקוד: <span style="color: #fde047; font-weight: bold;">${player.score}</span></div>
                    </div>
                `;
                playersInfo.appendChild(card);
            });
        }

        // עדכון לוח ניקוד קטן
        function updateScoreBoard() {
            const scoreBoard = document.getElementById('scoreBoard');
            scoreBoard.innerHTML = '';

            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

            sortedPlayers.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = `score-card ${index === 0 ? 'score-leader' : ''}`;
                
                const colorMap = {
                    'player-1': '#3b82f6',
                    'player-2': '#ffffff',
                    'player-3': '#22c55e',
                    'player-4': '#a855f7'
                };

                card.innerHTML = `
                    <div class="player-color" style="background-color: ${colorMap[player.color]}; ${player.color === 'player-2' ? 'border: 2px solid #4b5563;' : ''} margin: 0 auto 4px auto;"></div>
                    <div style="font-weight: bold; font-size: 0.8rem;">${player.name}</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: #fde047;">${player.score}</div>
                    ${index === 0 ? '<div style="font-size: 0.7rem; color: #fde047;">👑</div>' : ''}
                `;
                scoreBoard.appendChild(card);
            });
        }

        // עדכון פקדי קובייה
        function updateDiceControls() {
            document.getElementById('currentPlayerName').textContent = players[currentPlayer].name;
            
            const bonusMessage = document.getElementById('bonusMessage');
            const rollButton = document.getElementById('rollButton');
            
            if (bonusTurn) {
                bonusMessage.style.display = 'block';
                rollButton.textContent = '🎲🎉 הטל קובייה - תור בונוס!';
                rollButton.className = 'game-button bonus-button';
            } else {
                bonusMessage.style.display = 'none';
                rollButton.textContent = '🎲 הטל קובייה וזוז';
                rollButton.className = 'game-button';
            }
        }

        // הטלת קובייה ותנועה
        function handlePlayerTurn() {
            if (currentDilemma) return;

            diceValue = smartDiceRoll();
            animateDice(diceValue);
            
            setTimeout(() => {
                addLog(`${players[currentPlayer].name} הטיל קובייה וקיבל: ${diceValue}`);
                movePlayer(diceValue);

                if (bonusTurn) {
                    bonusTurn = false;
                    setTimeout(() => {
                        currentPlayer = (currentPlayer + 1) % players.length;
                        updateUI();
                    }, 1000);
                } else {
                    setTimeout(() => {
                        if (!currentDilemma) {
                            currentPlayer = (currentPlayer + 1) % players.length;
                            updateUI();
                        }
                    }, 1000);
                }
            }, 500);
        }

        // תנועת שחקן
        function movePlayer(steps) {
            const player = players[currentPlayer];
            const newPosition = Math.min(player.position + steps, boardPositions - 1);
            player.position = newPosition;

            if (!dilemmaSquares.includes(newPosition)) {
                player.turnsSinceDilemma++;
            } else {
                player.turnsSinceDilemma = 0;
            }

            // בדיקת דילמה - כל משבצת דילמה מקושרת לשאלה ספציפית
            if (dilemmaSquares.includes(newPosition)) {
                const specificDilemma = dilemmaCards.find(d => d.position === newPosition);
                if (specificDilemma) {
                    currentDilemma = specificDilemma;
                    showDilemma();
                    addLog(`${player.name} נתקל בדילמה: ${specificDilemma.title}`);
                }
            }

            if (newPosition >= boardPositions - 1) {
                addLog(`🎉 ${player.name} הצליח לברוח מכוכב צדק ונצח במשחק!`);
                player.score += 100;
            }

            updateUI();
        }

        // הצגת דילמה
        function showDilemma() {
            const modal = document.getElementById('dilemmaModal');
            const content = document.getElementById('dilemmaContent');
            
            selectedCard = null;
            showHint = false;
            explanation = '';
            answerFeedback = null;

            content.innerHTML = `
                <h4 style="font-size: 1.1rem; font-weight: bold; margin-bottom: 8px;">${currentDilemma.title}</h4>
                <p style="margin-bottom: 16px; color: #e5e7eb;">${currentDilemma.description}</p>
                <p style="font-size: 0.9rem; color: #d1d5db; margin-bottom: 16px;">
                    דרושים קלפים מסוג: <strong>${currentDilemma.requiredTypes.join(', ')}</strong> | 
                    קושי: ${'⭐'.repeat(currentDilemma.difficulty)}
                </p>
                
                <div id="feedbackArea"></div>
                
                <div id="cardSelection">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="font-weight: bold;">בחר קלף לפתרון:</label>
                        <button onclick="toggleHint()" style="background: #ea580c; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">
                            💡 ${showHint ? 'הסתר רמז' : 'רמז (-1 נקודה)'}
                        </button>
                    </div>
                    
                    <div class="cards-grid" id="cardsGrid">
                        ${knowledgeCards.map(card => `
                            <div>
                                <button onclick="selectCard(${card.id})" class="card-button" id="card-${card.id}">
                                    <div style="font-weight: bold; margin-bottom: 4px;">${card.icon} ${card.name}</div>
                                    <div style="font-size: 0.8rem; color: #d1d5db;">${card.type}</div>
                                    <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 4px;">${card.description}</div>
                                </button>
                                <div id="hint-${card.id}" style="display: none;"></div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin: 16px 0;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">הסבר את הפתרון שלך (לפחות 30 תווים):</label>
                        <textarea id="explanationText" placeholder="למשל: אני בוחר 'מגנים תרמיים' כי הם מתקינים לוחות מיוחדים על החללית שמחזירים את החום ומגנים על המבנה..." onInput="updateExplanation()"></textarea>
                        <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 4px;" id="charCount">0/30 תווים מינימום</div>
                    </div>
                    
                    <button onclick="solveDilemma()" id="solveButton" class="game-button" style="background: #16a34a;" disabled>
                        ✅ פתור את הדילמה
                    </button>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // בחירת קלף
        function selectCard(cardId) {
            selectedCard = cardId;
            
            knowledgeCards.forEach(card => {
                const cardElement = document.getElementById(`card-${card.id}`);
                if (card.id === cardId) {
                    cardElement.classList.add('card-selected');
                } else {
                    cardElement.classList.remove('card-selected');
                }
            });

            updateHintDisplay();
            updateSolveButton();
        }

        // החלפת רמז
        function toggleHint() {
            showHint = !showHint;
            updateHintDisplay();
            
            const hintButton = document.querySelector('[onclick="toggleHint()"]');
            hintButton.textContent = `💡 ${showHint ? 'הסתר רמז' : 'רמז (-1 נקודה)'}`;
        }

        // עדכון הצגת רמז
        function updateHintDisplay() {
            knowledgeCards.forEach(card => {
                const hintElement = document.getElementById(`hint-${card.id}`);
                if (showHint && selectedCard === card.id) {
                    hintElement.style.display = 'block';
                    hintElement.innerHTML = `<div class="hint-box"><strong>💡 רמז:</strong> ${card.hint}</div>`;
                } else {
                    hintElement.style.display = 'none';
                }
            });
        }

        // עדכון הסבר
        function updateExplanation() {
            explanation = document.getElementById('explanationText').value;
            document.getElementById('charCount').textContent = `${explanation.length}/30 תווים מינימום`;
            updateSolveButton();
        }

        // עדכון כפתור פתרון
        function updateSolveButton() {
            const button = document.getElementById('solveButton');
            button.disabled = !selectedCard || explanation.length < 30;
        }

        // פתרון דילמה
        function solveDilemma() {
            if (!selectedCard || explanation.length < 30) {
                alert('נא לבחור קלף ולכתוב הסבר!');
                return;
            }

            const feedback = evaluateAnswer();
            showFeedback(feedback);

            // רישום התשובה ביומן
            const selectedCardName = knowledgeCards.find(c => c.id === selectedCard).name;
            addLog(`${players[currentPlayer].name} בחר: "${selectedCardName}" והסביר: "${explanation.substring(0, 50)}..."`);

            let bonusSteps = 0;
            let points = 0;
            let hintPenalty = showHint ? 1 : 0;

            if (feedback.status === 'correct') {
                bonusSteps = 3;
                points = (currentDilemma.difficulty * 10) - hintPenalty;
            } else if (feedback.status === 'partial') {
                bonusSteps = 1;
                points = 5 - hintPenalty;
            } else {
                points = 0;
                bonusSteps = 0;
            }

            addLog(feedback.message);
            if (bonusSteps > 0) {
                addLog(`${players[currentPlayer].name} זוכה ב-${bonusSteps} צעדי בונוס ו-${points} נקודות!`);
            }

            players[currentPlayer].score += points;
            players[currentPlayer].knowledge = Math.max(0, players[currentPlayer].knowledge - 1);

            if (bonusSteps > 0) {
                setTimeout(() => {
                    movePlayer(bonusSteps);
                    bonusTurn = true;
                    addLog(`${players[currentPlayer].name} מקבל תור בונוס! הטילי שוב קובייה!`);
                    closeDilemma();
                }, 2000);
            } else {
                setTimeout(() => {
                    currentPlayer = (currentPlayer + 1) % players.length;
                    closeDilemma();
                }, 2000);
            }
        }

        // הערכת התשובה
        function evaluateAnswer() {
            const card = knowledgeCards.find(c => c.id === selectedCard);
            const explanationWords = explanation.trim().toLowerCase().split(' ');

            const hasRelevantWords = currentDilemma.keywords.some(keyword => 
                explanationWords.some(word => word.includes(keyword))
            );

            const isCorrectType = currentDilemma.requiredTypes.includes(card.type);
            const isLongEnough = explanation.length >= 30;

            if (isCorrectType && hasRelevantWords && isLongEnough) {
                return { status: 'correct', message: '✅ תשובה מצוינת! הסברת נכון איך הפתרון הטכני פותר את הבעיה הפיזיקלית.' };
            } else if (isCorrectType && isLongEnough) {
                return { status: 'partial', message: '⚡ תשובה טובה! הקלף מתאים אבל ההסבר יכול להיות יותר טכני ומדעי.' };
            } else if (isCorrectType) {
                return { status: 'partial', message: '⚡ כיוון נכון! נסה להרחיב את ההסבר - איך בדיוק הטכנולוגיה פותרת את הבעיה?' };
            } else {
                return { status: 'wrong', message: '❌ הקלף לא ממש מתאים לבעיה הזו. חשוב על פתרון טכני אחר או קח רמז!' };
            }
        }

        // הצגת משוב
        function showFeedback(feedback) {
            const feedbackArea = document.getElementById('feedbackArea');
            const cardSelection = document.getElementById('cardSelection');
            
            let feedbackClass = 'feedback-wrong';
            if (feedback.status === 'correct') feedbackClass = 'feedback-correct';
            else if (feedback.status === 'partial') feedbackClass = 'feedback-partial';
            
            feedbackArea.innerHTML = `
                <div class="feedback-box ${feedbackClass}">${feedback.message}</div>
                <div class="correct-answer">
                    <strong>💡 הפתרון המומלץ:</strong><br>
                    ${currentDilemma.correctAnswer}
                </div>
            `;
            cardSelection.style.display = 'none';
        }

        // סגירת דילמה
        function closeDilemma() {
            setTimeout(() => {
                document.getElementById('dilemmaModal').style.display = 'none';
                currentDilemma = null;
                updateUI();
            }, 1000);
        }

        // הוספה ליומן
        function addLog(message) {
            gameLog.push(message);
            if (gameLog.length > 6) gameLog.shift();
            
            const logElement = document.getElementById('gameLog');
            logElement.innerHTML = gameLog.map(entry => 
                `<div class="log-entry">${entry}</div>`
            ).join('');
        }

        // איפוס משחק
        function resetGame() {
            players = [
                { id: 1, name: 'מהנדס 1', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-1', turnsSinceDilemma: 0 },
                { id: 2, name: 'מהנדסת 2', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-2', turnsSinceDilemma: 0 },
                { id: 3, name: 'מהנדס 3', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-3', turnsSinceDilemma: 0 },
                { id: 4, name: 'מהנדסת 4', position: 0, energy: 10, parts: 5, knowledge: 3, score: 0, color: 'player-4', turnsSinceDilemma: 0 }
            ];
            currentPlayer = 0;
            bonusTurn = false;
            gameLog = [];
            currentDilemma = null;
            usedDilemmas = [];
            document.getElementById('dilemmaModal').style.display = 'none';
            
            addLog('משחק חדש התחיל!');
            updateUI();
        }

        // עדכון ממשק משתמש
        function updateUI() {
            buildBoard();
            updatePlayersInfo();
            updateScoreBoard();
            updateDiceControls();
        }

        // אתחול המשחק
        addLog('המשחק מוכן! לחצו "התחל משחק" כדי להתחיל');
    </script>
</body>
</html>
